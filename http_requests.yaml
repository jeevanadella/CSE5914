openapi: 3.0.4
info:
  title: Research Paper Analysis API
  version: 1.0.0
  description: |
    An API for a platform that allows users to search, analyze, and compare multiple research papers and their codebases. 
    It integrates with OpenAlex, arXiv, and GitHub, using LLMs for advanced querying and analysis.

tags:
  - name: Health
    description: API Health Status
  - name: Discovery
    description: Search for papers in external sources like arXiv and OpenAlex.
  - name: Papers
    description: Manage papers that have been imported into the system.
  - name: Users
    description: Manage users who curate papers and run analysis.
  - name: Chat
    description: Perform RAG-based Q&A on papers and code (specialized operations included).
  - name: Code
    description: Manage codebases linked to papers.
  - name: History
    description: Minimal chat sessions and messages (CRUD-lite).

paths:
  /health:
    get:
      tags: [Health]
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string, example: ok }

  /discovery/search:
    get:
      tags: [Discovery]
      summary: Search external sources for papers
      description: Queries external APIs like OpenAlex and arXiv to find papers not yet in the system. Supports both keyword and semantic search.
      parameters:
        - in: query
          name: q
          required: true
          schema: { type: string }
          example: '"contrastive learning"'
        - in: query
          name: source
          schema:
            type: string
            enum: [openalex, arxiv]
        - in: query
          name: searchType
          schema:
            type: string
            enum: [keyword, semantic, hybrid]
            default: hybrid
          description: "Type of search - keyword (exact match), semantic (meaning-based), or hybrid (both)"
        - in: query
          name: page
          schema:
            type: integer
            default: 1
          description: "The page number to retrieve."
        - in: query
          name: perPage
          schema:
            type: integer
            default: 10
            maximum: 100
          description: "The number of papers to retrieve per page."
        - in: query
          name: expandQuery
          schema:
            type: boolean
            default: true
          description: "Whether to expand the query with related terms and synonyms"
        - in: query
          name: minYear
          schema: { type: integer }
          description: "Filter by minimum publication year"
        - in: query
          name: maxYear
          schema: { type: integer }
          description: "Filter by maximum publication year"
        - in: query
          name: minCitations
          schema: { type: integer }
          description: "Filter by minimum citation count"
      responses:
        '200':
          description: A paginated list of discovered papers with enhanced search metadata.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PaginatedDiscoveredPapers'
                  - type: object
                    properties:
                      searchType:
                        type: string
                        description: "The type of search performed"
                      expandedQuery:
                        type: string
                        description: "The expanded query after processing (if expandQuery=true)"
                      explanation:
                        type: string
                        description: "Explanation of search strategy and results"

  /papers/import:
    post:
      tags: [Papers]
      summary: Import papers from external sources
      description: Triggers an asynchronous ingestion job for one or more papers found via the discovery endpoint.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                papers:
                  type: array
                  items:
                    type: object
                    properties:
                      source: { type: string, enum: [openalex, arxiv] }
                      externalId: { type: string }
      responses:
        '202':
          description: Import job accepted.
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobId: { type: string }
                  status: { type: string, example: "queued" }

  /papers/upload:
    post:
      tags: [Papers]
      summary: Upload a PDF for ingestion
      description: Ingests a paper directly from a PDF file for cases where it cannot be found in external sources.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file: { type: string, format: binary }
      responses:
        '202':
          description: Ingestion job accepted.

  /papers/{paperId}:
    get:
      tags: [Papers]
      summary: Get paper details
      parameters:
        - in: path
          name: paperId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Full details of the paper.
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PaperFull' }

  /papers/{paperId}/code:
    post:
      tags: [Code]
      summary: Link a codebase to a paper
      description: Links a GitHub repository to a specific paper for analysis.
      parameters:
        - in: path
          name: paperId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [repositoryUrl]
              properties:
                repositoryUrl:
                  type: string
                  format: uri
                  example: "https://github.com/facebookresearch/llama"
      responses:
        '202':
          description: Codebase linking job accepted.

    get:
      tags: [Code]
      summary: Get linked codebase details
      description: Retrieves the file structure and other metadata of the codebase linked to a paper.
      parameters:
        - in: path
          name: paperId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Details of the linked codebase.
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Codebase' }
  
  /papers/{paperId}/code-links:
    get:
      tags: [Code]
      summary: Find GitHub links in a paper
      description: Scans the full text of an ingested paper to find and extract any mentioned GitHub repository links.
      parameters:
        - in: path
          name: paperId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: A list of GitHub links found in the paper.
          content:
            application/json:
              schema:
                type: object
                properties:
                  links:
                    type: array
                    items:
                      type: string
                      format: uri
                      example: "https://github.com/facebookresearch/llama"

  /papers/{paperId}/code/content:
    get:
      tags: [Code]
      summary: Get file content from a codebase
      description: Retrieves the content of a specific file from the linked repository.
      parameters:
        - in: path
          name: paperId
          required: true
          schema: { type: string }
        - in: query
          name: filePath
          required: true
          schema: { type: string }
          example: "README.md"
      responses:
        '200':
          description: The content of the file.
          content:
            text/plain:
              schema:
                type: string

  /papers/{paperId}/code/dependencies:
    get:
      tags: [Code]
      summary: Get dependency analysis of the codebase
      description: Parses dependency files like requirements.txt or package.json to identify project dependencies.
      parameters:
        - in: path
          name: paperId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: A list of dependencies.
          content:
            application/json:
              schema:
                type: object
                properties:
                  dependencies:
                    type: array
                    items:
                      type: object
                      properties:
                        name: { type: string }
                        version: { type: string }

  /papers/{paperId}/code/search:
    get:
      tags: [Code]
      summary: Keyword search within the codebase
      description: Performs a keyword search over the code in the linked repository.
      parameters:
        - in: path
          name: paperId
          required: true
          schema: { type: string }
        - in: query
          name: q
          required: true
          schema: { type: string }
          example: "augmentation"
      responses:
        '200':
          description: A list of relevant code snippets matching the keyword.
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/CodeCitation' }

  /papers/{paperId}/code/commits:
    get:
      tags: [Code]
      summary: Get commit history
      description: Retrieves the commit history for a specific file or the entire repository.
      parameters:
        - in: path
          name: paperId
          required: true
          schema: { type: string }
        - in: query
          name: filePath
          schema: { type: string }
          description: "Optional: Specify a file path to get its commit history."
        - in: query
          name: page
          schema:
            type: integer
            default: 1
          description: "The page number to retrieve."
        - in: query
          name: perPage
          schema:
            type: integer
            default: 10
            maximum: 100
          description: "The number of commits to retrieve per page."
      responses:
        '200':
          description: A paginated list of commits.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedCommits'

  /papers/{paperId}/code/metrics:
    get:
      tags: [Code]
      summary: Get code complexity metrics
      description: Calculates complexity metrics for a specific file (e.g., cyclomatic complexity).
      parameters:
        - in: path
          name: paperId
          required: true
          schema: { type: string }
        - in: query
          name: filePath
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Code complexity metrics.
          content:
            application/json:
              schema:
                type: object
                properties:
                  cyclomaticComplexity: { type: integer }
                  linesOfCode: { type: integer }

  /papers/{paperId}/code/structure:
    get:
      tags: [Code]
      summary: Get code structure
      description: Lists all functions and classes within a given file.
      parameters:
        - in: path
          name: paperId
          required: true
          schema: { type: string }
        - in: query
          name: filePath
          required: true
          schema: { type: string }
      responses:
        '200':
          description: A list of functions and classes.
          content:
            application/json:
              schema:
                type: object
                properties:
                  functions:
                    type: array
                    items: { type: string }
                  classes:
                    type: array
                    items: { type: string }

  /users:
    post:
      tags: [Users]
      summary: Create a new user
      description: Registers a new user in the system.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, email]
              properties:
                name:
                  type: string
                  example: "Alice Chen"
                email:
                  type: string
                  format: email
                  example: "alice@example.com"
      responses:
        '201':
          description: User created successfully.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

    get:
      tags: [Users]
      summary: List all users
      description: Retrieve all registered users.
      responses:
        '200':
          description: A list of users.
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'

  /users/{userId}:
    get:
      tags: [Users]
      summary: Get user by ID
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      responses:
        '200':
          description: The user details.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

    delete:
      tags: [Users]
      summary: Delete a user
      description: Deletes a user and all associated data (papers, chat history, etc.).
      parameters:
        - in: path
          name: userId
          required: true
          schema:
            type: string
      responses:
        '204':
          description: User deleted successfully.

  /users/{userId}/papers:
    put:
      tags: [Users]
      summary: Add or remove papers for a user
      parameters:
        - in: path
          name: userId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                paperIds:
                  type: array
                  items: { type: string }
      responses:
        '200':
          description: User's paper list updated.

  # ---------------------------
  # Chat (specialized operations)
  # ---------------------------

  /chat/qa:
    post:
      tags: [Chat]
      summary: Chat over papers and code (general Q&A)
      description: Performs RAG Q&A, optionally scoped to a specific user's selected papers.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [question]
              properties:
                question:
                  type: string
                  example: "How does the code handle data augmentation?"
                userId:
                  type: string
                  description: "Optional: Scope the chat to a specific user's papers."
                paperIds:
                  type: array
                  description: "Optionally restrict retrieval to these paper IDs."
                  items: { type: string }
                searchCode:
                  type: boolean
                  description: "If true, also search linked codebases."
                  default: false
                maxContexts:
                  type: integer
                  default: 8
                  description: "Max retrieved chunks used for grounding."
      responses:
        '200':
          description: Answer with citations.
          content:
            application/json:
              schema: { $ref: '#/components/schemas/QAResponse' }

  /chat/summarize:
    post:
      tags: [Chat]
      summary: Summarize one or many papers
      description: Produce hierarchical or bullet summaries at configurable granularity.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [paperIds]
              properties:
                paperIds:
                  type: array
                  items: { type: string }
                  example: [paper123, paper456]
                focus:
                  type: string
                  enum: [abstract, intro, methods, results, conclusion, full]
                  default: full
                style:
                  type: string
                  enum: [bullets, narrative, tl;dr]
                  default: bullets
                length:
                  type: string
                  enum: [short, medium, long]
                  default: medium
                includeCitations:
                  type: boolean
                  default: true
      responses:
        '200':
          description: Summaries with optional citations
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        paperId: { type: string }
                        summary: { type: string }
                        citations:
                          type: array
                          items: { $ref: '#/components/schemas/PaperCitation' }

  /chat/outline:
    post:
      tags: [Chat]
      summary: Generate structured outlines
      description: Returns a section/subsection outline for study notes, slides, or lectures based on given papers.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                paperIds:
                  type: array
                  items: { type: string }
                depth:
                  type: integer
                  default: 2
                  description: "Heading depth (1-3)."
                audience:
                  type: string
                  example: "graduate ML course"
      responses:
        '200':
          description: Outline
          content:
            application/json:
              schema:
                type: object
                properties:
                  outline:
                    type: array
                    items:
                      type: object
                      properties:
                        heading: { type: string }
                        level: { type: integer }
                        children:
                          type: array
                          items:
                            type: object
                            properties:
                              heading: { type: string }
                              level: { type: integer }

  /chat/extract:
    post:
      tags: [Chat]
      summary: Schema-guided information extraction
      description: Extract structured facts (datasets, metrics, hyperparams, claims) using a JSON schema.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [paperIds, schema]
              properties:
                paperIds:
                  type: array
                  items: { type: string }
                schema:
                  type: object
                  description: "JSON Schema for expected output."
                  example:
                    type: object
                    properties:
                      datasets: { type: array, items: { type: string } }
                      metrics: { type: array, items: { type: string } }
                      bestResult:
                        type: object
                        properties:
                          dataset: { type: string }
                          value: { type: number }
                includeCode:
                  type: boolean
                  default: false
      responses:
        '200':
          description: Extracted structured data with citations
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                  citations:
                    type: array
                    items: { $ref: '#/components/schemas/PaperCitation' }

  /chat/citations:
    post:
      tags: [Chat]
      summary: Generate formatted citations
      description: Return a bibliography for given papers in a target format (e.g., BibTeX, APA).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [paperIds, format]
              properties:
                paperIds:
                  type: array
                  items: { type: string }
                format:
                  type: string
                  enum: [bibtex, apa, mla, chicago]
                  example: bibtex
      responses:
        '200':
          description: Formatted citations
          content:
            application/json:
              schema:
                type: object
                properties:
                  entries:
                    type: array
                    items:
                      type: string
                      example: |
                        @inproceedings{smith2021awesome,
                          title={Awesome Paper}, author={Smith, J. and Doe, A.}, year={2021}, booktitle={NeurIPS}
                        }

  /chat/code-qa:
    post:
      tags: [Chat]
      summary: Code-aware Q&A
      description: Answer questions requiring both paper context and linked repository reasoning (cross-references included).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [question]
              properties:
                question:
                  type: string
                  example: "How is label smoothing implemented compared to the method section?"
                paperId:
                  type: string
                repoPaths:
                  type: array
                  items: { type: string }
                  description: "Optional file path filters within the linked repo."
                maxSnippets:
                  type: integer
                  default: 6
      responses:
        '200':
          description: Answer with paper and code citations
          content:
            application/json:
              schema: { $ref: '#/components/schemas/QAResponse' }
  /chat/compare:
    post:
      tags: [Chat]
      summary: General cross-paper comparison (narrative)
      description: Compares papers across all major dimensions (methods, datasets, metrics/results, code/implementation, compute, limitations, novelty, etc.) and returns a narrative synthesis with citations.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [paperIds]
              properties:
                paperIds:
                  type: array
                  items: { type: string }
                  example: [paper123, paper456, paper789]
                includeCode:
                  type: boolean
                  description: "Also contrast linked codebases where available."
                  default: true
                includeCitations:
                  type: boolean
                  description: "Include supporting citations for claims."
                  default: true
      responses:
        '200':
          description: Narrative comparison with citations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QAResponse'
  
  /chat/sessions:
    post:
      tags: [History]
      summary: Create a chat session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userId: { type: string }
                title: { type: string, example: "Paper comparison chat" }
                context:
                  type: object
                  properties:
                    paperIds:
                      type: array
                      items: { type: string }
      responses:
        '201':
          description: Session created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ChatSession' }

    get:
      tags: [History]
      summary: List sessions (by user)
      parameters:
        - in: query
          name: userId
          required: true
          schema: { type: string }
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: perPage
          schema: { type: integer, default: 20, maximum: 100 }
      responses:
        '200':
          description: Paginated sessions
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalItems: { type: integer }
                  totalPages: { type: integer }
                  currentPage: { type: integer }
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/ChatSession' }

  /chat/sessions/{sessionId}:
    get:
      tags: [History]
      summary: Get a session
      parameters:
        - in: path
          name: sessionId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Session
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ChatSession' }

    delete:
      tags: [History]
      summary: Delete a session (and its messages)
      parameters:
        - in: path
          name: sessionId
          required: true
          schema: { type: string }
      responses:
        '204':
          description: Deleted

  /chat/sessions/{sessionId}/messages:
    get:
      tags: [History]
      summary: List messages in a session
      parameters:
        - in: path
          name: sessionId
          required: true
          schema: { type: string }
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: perPage
          schema: { type: integer, default: 50, maximum: 200 }
        - in: query
          name: order
          schema: { type: string, enum: [asc, desc], default: asc }
      responses:
        '200':
          description: Messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  totalItems: { type: integer }
                  totalPages: { type: integer }
                  currentPage: { type: integer }
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/ChatMessage' }

    post:
      tags: [History]
      summary: Append a message to a session
      description: Adds a user or assistant message. (Use /chat/qa separately to generate answers.)
      parameters:
        - in: path
          name: sessionId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role, content]
              properties:
                role: { type: string, enum: [user, assistant] }
                content: { type: string }
      responses:
        '201':
          description: Message created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ChatMessage' }

components:
  schemas:
    DiscoveredPaper:
      type: object
      properties:
        source: { type: string, enum: [openalex, arxiv] }
        externalId: { type: string }
        title: { type: string }
        authors: { type: array, items: { type: string } }
        year: { type: integer }
        abstract: { type: string }
        relevanceScore:
          type: number
          format: float
          description: "Semantic relevance score (0-1) for semantic search results"
        matchType:
          type: string
          enum: [keyword, semantic, both]
          description: "How this result matched the query"

    Paper:
      type: object
      properties:
        id: { type: string }
        title: { type: string }
        authors: { type: array, items: { type: string } }
        year: { type: integer }
        citationCount: { type: integer }
        codebase: { $ref: '#/components/schemas/CodebaseInfo' }

    PaperFull:
      allOf:
        - $ref: '#/components/schemas/Paper'
        - type: object
          properties:
            abstract: { type: string }
            ingestionStatus: { type: string, enum: [queued, processing, completed, failed] }

    User:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        email: { type: string, format: email }
        paperIds:
          type: array
          items: { type: string }
        createdAt: { type: string, format: date-time }

    PaperCitation:
      type: object
      properties:
        paperId: { type: string }
        passage: { type: string }

    CodeCitation:
      type: object
      properties:
        paperId: { type: string }
        filePath: { type: string }
        snippet: { type: string }

    QAResponse:
      type: object
      properties:
        answer: { type: string }
        citations:
          type: array
          items:
            oneOf:
              - $ref: '#/components/schemas/PaperCitation'
              - $ref: '#/components/schemas/CodeCitation'

    CodebaseInfo:
      type: object
      properties:
        repositoryUrl:
          type: string
          format: uri
          description: "The URL of the linked GitHub repository."
        isLinked:
          type: boolean
          default: false
          description: "Indicates if a repository is linked and has been synchronized."

    Codebase:
      allOf:
        - $ref: '#/components/schemas/CodebaseInfo'
        - type: object
          properties:
            fileTree:
              type: array
              items:
                $ref: '#/components/schemas/FileNode'
              description: "The hierarchical file structure of the repository."
            lastSyncedAt:
              type: string
              format: date-time
              description: "The timestamp of the last successful synchronization."

    FileNode:
      type: object
      properties:
        name: { type: string }
        path: { type: string }
        type: { type: string, enum: [file, directory] }
        children:
          type: array
          items:
            $ref: '#/components/schemas/FileNode'
    
    Commit:
      type: object
      properties:
        sha: { type: string }
        message: { type: string }
        author: { type: string }
        date: { type: string, format: date-time }

    PaginatedCommits:
      type: object
      properties:
        totalItems: { type: integer }
        totalPages: { type: integer }
        currentPage: { type: integer }
        items:
          type: array
          items:
            $ref: '#/components/schemas/Commit'

    PaginatedDiscoveredPapers:
      type: object
      properties:
        totalItems: { type: integer }
        totalPages: { type: integer }
        currentPage: { type: integer }
        items:
          type: array
          items:
            $ref: '#/components/schemas/DiscoveredPaper'

    ComparisonResult:
      type: object
      properties:
        comparisonId: { type: string, description: "Unique identifier for the comparison session" }
        table:
          type: array
          description: "Structured comparison table across papers"
          items:
            type: object
            properties:
              dimension: { type: string, description: "The comparison dimension (e.g., algorithms, datasets, metrics, results)" }
              values:
                type: array
                description: "Values for each paper under this dimension"
                items:
                  type: object
                  properties:
                    paperId: { type: string }
                    value: { type: string }

    ChatSession:
      type: object
      properties:
        id: { type: string }
        userId: { type: string }
        title: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
        messageCount: { type: integer }
        context:
          type: object
          properties:
            paperIds:
              type: array
              items: { type: string }

    ChatMessage:
      type: object
      properties:
        id: { type: string }
        sessionId: { type: string }
        role: { type: string, enum: [user, assistant] }
        content: { type: string }
        createdAt: { type: string, format: date-time }
